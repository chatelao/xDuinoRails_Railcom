<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Railcom Decoder Tests</title>
  <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.20.0.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="https://code.jquery.com/qunit/qunit-2.20.0.js"></script>
  <script src="script.js"></script>
  <script>
    QUnit.module('Railcom Decoding', function() {
      QUnit.test('decode6of8 should correctly decode all values from the ENCODE_TABLE', function(assert) {
        for (let i = 0; i < ENCODE_TABLE.length; i++) {
          const encodedValue = ENCODE_TABLE[i];
          const expectedDecodedValue = i;
          assert.equal(decode6of8(encodedValue), expectedDecodedValue, `Test case for 0x${encodedValue.toString(16).toUpperCase()}`);
        }
      });

      QUnit.test('decode6of8 should return undefined for invalid bytes', function(assert) {
        // Test a few values that are not in the ENCODE_TABLE
        assert.equal(decode6of8(0x00), undefined, "Invalid byte 0x00");
        assert.equal(decode6of8(0xFF), undefined, "Invalid byte 0xFF");
        assert.equal(decode6of8(0x5B), undefined, "Invalid byte 0x5B");
      });
      QUnit.test('formatHex', function(assert) {
        assert.equal(formatHex("D2"), "D2", "Single byte");
        assert.equal(formatHex("0580"), "05_80", "Two bytes");
        assert.equal(formatHex("12345"), "12_34_5", "Odd number of nibbles");
      });
      QUnit.test('formatBinary', function(assert) {
        assert.equal(formatBinary("11010010"), "1101_0010", "Single byte");
        assert.equal(formatBinary("0000010110000000"), "0000_0101_1000_0000", "Two bytes");
        assert.equal(formatBinary("00010010001101000101"), "0001_0010_0011_0100_0101", "Odd number of nibbles");
      });
      QUnit.test('decodeRawId', function(assert) {
        // Test Case 1: ADR_LOW, address 1234. The low byte is 210.
        assert.equal(decodeRawId([11, 18]), "ID: ADR_LOW (2)\nPayload: 0xD2", "ADR_LOW, address 1234");

        // Test Case 2: POM, CV 5, value 128.
        assert.equal(decodeRawId([0, 0, 22, 0]), "ID: POM (0)\nPayload: 0x05_80", "POM, CV 5, value 128");

        // Test Case 3: ADR_HIGH, address 1234. The high byte is 4.
        assert.equal(decodeRawId([4, 16]), "ID: ADR_HIGH (1)\nPayload: 0x10 (0b0001_0000)", "ADR_HIGH, address 1234");

        // Test Case 4: TIME, 12.7 seconds.
        assert.equal(decodeRawId([21, 63]), "ID: TIME (5)\nPayload: 0x7F (0b0111_1111)", "TIME, 12.7s");

        // Test Case 5: TIME, 127 seconds.
        assert.equal(decodeRawId([23, 63]), "ID: TIME (5)\nPayload: 0xFF (0b1111_1111)", "TIME, 127s");
      });
      QUnit.test('decodePayload', function(assert) {
        // Test Case 1: DYN message, Value 128, Subindex 0 (Speed)
        assert.equal(decodePayload([30, 0, 0]), "ID: DYN (7)\nValue: 128 (0x80)\nSubindex: 0 (True speed, part 1)\n<a href=\"encoder.html?id=7&payload=2000\" target=\"_blank\">Edit</a>", "DYN, Speed");

        // Test Case 2: POM, CV 5, value 128.
        assert.equal(decodePayload([0, 0, 22, 0]), "ID: POM (0)\nCV: 5 (0x5)\nValue: 128\n<a href=\"encoder.html?id=0&payload=0580\" target=\"_blank\">Edit</a>", "POM, CV 5, value 128");

        // Test Case 3: ADR_HIGH, address part 4.
        assert.equal(decodePayload([4, 16]), "ID: ADR_HIGH (1)\nAddress part: 4 (0b00000100)\n<a href=\"encoder.html?id=1&payload=10\" target=\"_blank\">Edit</a>", "ADR_HIGH, address part 4");

        // Test Case 4: TIME, 12.7 seconds
        assert.equal(decodePayload([21, 63]), "ID: TIME (5)\nRestlaufzeit: 12.7 Sekunden\n<a href=\"encoder.html?id=5&payload=7F\" target=\"_blank\">Edit</a>", "TIME, 12.7s");

        // Test Case 5: TIME, 127 seconds
        assert.equal(decodePayload([23, 63]), "ID: TIME (5)\nRestlaufzeit: 127 Sekunden\n<a href=\"encoder.html?id=5&payload=FF\" target=\"_blank\">Edit</a>", "TIME, 127s");

        // Test Case 6: SRQ, Address 2047, Extended
        assert.equal(decodePayload([59, 63, 60]), "ID: SRQ (14)\nSRQ\nAccessory Address: 2047\nExtended: Yes\n<a href=\"encoder.html?id=14&payload=3FFC\" target=\"_blank\">Edit</a>", "SRQ, Address 2047, Extended");
      });
    });
  </script>
</body>
</html>
