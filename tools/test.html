<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Railcom Decoder Tests</title>
  <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.20.0.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="https://code.jquery.com/qunit/qunit-2.20.0.js"></script>
  <script src="script.js"></script>
  <script>
    QUnit.module('Railcom Decoding', function() {
      QUnit.test('decode6of8 should correctly decode all values from the ENCODE_TABLE', function(assert) {
        for (let i = 0; i < ENCODE_TABLE.length; i++) {
          const encodedValue = ENCODE_TABLE[i];
          const expectedDecodedValue = i;
          assert.equal(decode6of8(encodedValue), expectedDecodedValue, `Test case for 0x${encodedValue.toString(16).toUpperCase()}`);
        }
      });

      QUnit.test('decode6of8 should return undefined for invalid bytes', function(assert) {
        // Test a few values that are not in the ENCODE_TABLE
        assert.equal(decode6of8(0x00), undefined, "Invalid byte 0x00");
        assert.equal(decode6of8(0xFF), undefined, "Invalid byte 0xFF");
        assert.equal(decode6of8(0x5B), undefined, "Invalid byte 0x5B");
      });
      QUnit.test('formatHex', function(assert) {
        assert.equal(formatHex("D2"), "D2", "Single byte");
        assert.equal(formatHex("0580"), "05_80", "Two bytes");
        assert.equal(formatHex("12345"), "12_34_5", "Odd number of nibbles");
      });
      QUnit.test('formatBinary', function(assert) {
        assert.equal(formatBinary("11010010"), "1101_0010", "Single byte");
        assert.equal(formatBinary("0000010110000000"), "0000_0101_1000_0000", "Two bytes");
        assert.equal(formatBinary("00010010001101000101"), "0001_0010_0011_0100_0101", "Odd number of nibbles");
      });
      QUnit.test('decodeRawId', function(assert) {
        // Test Case 1: ADR_LOW, address 1234. The low byte is 210.
        assert.equal(decodeRawId([11, 18]), "ID: ADR_LOW (2)\nPayload: 0xD2", "ADR_LOW, address 1234");

        // Test Case 2: POM, CV 5, value 128.
        assert.equal(decodeRawId([0, 0, 22, 0]), "ID: POM (0)\nPayload: 0x05_80", "POM, CV 5, value 128");

        // Test Case 3: ADR_HIGH, address 1234. The high byte is 4.
        assert.equal(decodeRawId([4, 4]), "ID: ADR_HIGH (1)\nPayload: 0x04", "ADR_HIGH, address 1234");

        // Test Case 4: TIME, time 0x12345.
        assert.equal(decodeRawId([52, 53, 53, 5]), "ID: TIME (5)\nPayload: 0x12_34_5", "TIME, time 0x12345");
      });
      QUnit.test('decodePayload', function(assert) {
        // Test Case 1: DYN message, Subindex 0 (Speed)
        assert.equal(decodePayload([28, 0, 0]), "ID: DYN (7)\nValue: 128\nSubindex: 0 (Speed)", "DYN, Speed");

        // Test Case 2: POM, CV 5, value 128.
        assert.equal(decodePayload([0, 0, 22, 0]), "ID: POM (0)\nCV: 5 (0x5)\nValue: 128", "POM, CV 5, value 128");

        // Test Case 3: ADR_HIGH, address 1234. The high byte is 4.
        assert.equal(decodePayload([4, 4]), "ID: ADR_HIGH (1)\nAddress part: 4 (0b00000100)", "ADR_HIGH, address 1234");

        // Test Case 4: TIME, time 0x12345.
        assert.equal(decodePayload([52, 53, 53, 5]), "ID: TIME (5)\nTime: 74565 ms", "TIME, time 0x12345");
      });
    });
  </script>
</body>
</html>
