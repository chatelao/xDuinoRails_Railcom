<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Railcom Decoder Tests</title>
  <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.20.0.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="https://code.jquery.com/qunit/qunit-2.20.0.js"></script>
  <script src="script.js"></script>
  <script>
    QUnit.module('Railcom Decoding', function() {
      QUnit.test('decode4of8 should correctly decode all values from the ENCODE_TABLE', function(assert) {
        for (let i = 0; i < ENCODE_TABLE.length; i++) {
          const encodedValue = ENCODE_TABLE[i];
          const expectedDecodedValue = i;
          assert.equal(decode4of8(encodedValue), expectedDecodedValue, `Test case for 0x${encodedValue.toString(16).toUpperCase()}`);
        }
      });

      QUnit.test('decode4of8 should return undefined for invalid bytes', function(assert) {
        // Test a few values that are not in the ENCODE_TABLE
        assert.equal(decode4of8(0x00), undefined, "Invalid byte 0x00");
        assert.equal(decode4of8(0xFF), undefined, "Invalid byte 0xFF");
        assert.equal(decode4of8(0x5B), undefined, "Invalid byte 0x5B");
      });
      QUnit.test('decodePayload', function(assert) {
        // Test Case 1: ADR_LOW, address 1234. The low byte is 210.
        // ID=2, payload=210, 8 payload bits. Total bits = 12.
        // Data = (2 << 8) | 210 = 722.
        // 6-bit chunks of 722 are 11 and 18.
        assert.equal(decodePayload([11, 18]), "ID: ADR_LOW\nPayload: 210", "ADR_LOW, address 1234");

        // Test Case 2: POM, CV 5, value 128. Payload is 1408.
        // ID=0, payload=1408, 18 payload bits. Total bits = 22, padded to 24 (4 chunks).
        // Data = (0 << 18) | 1408 = 1408.
        // 6-bit chunks of 1408 (padded to 24 bits) are 0, 0, 22, 0.
        assert.equal(decodePayload([0, 0, 22, 0]), "ID: POM\nPayload: 1408", "POM, CV 5, value 128");

        // Test Case 3: ADR_HIGH, address 1234. The high byte is 4.
        // ID=1, payload=4, 8 payload bits. Total bits = 12.
        // Data = (1 << 8) | 4 = 260.
        // 6-bit chunks of 260 are 4 and 4.
        assert.equal(decodePayload([4, 4]), "ID: ADR_HIGH\nPayload: 4", "ADR_HIGH, address 1234");

        // Test Case 4: TIME, time 0x12345.
        // ID=5, payload=0x12345, 18 payload bits. Total bits = 22, padded to 24 (4 chunks).
        // Data = (5 << 18) | 0x12345 = 1384517.
        // 6-bit chunks of 1384517 are 52, 53, 53, 5.
        assert.equal(decodePayload([52, 53, 53, 5]), "ID: TIME\nPayload: 74565", "TIME, time 0x12345");
      });
    });
  </script>
</body>
</html>
